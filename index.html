<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Pavimentação</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#00a884">
<style>
:root{
  --bg:#0b141a;--panel:#111b21;--card:#202c33;--text:#e9edef;
  --sub:#8696a0;--accent:#00a884;--border:#2a3942;
}
@media (prefers-color-scheme: light){
  :root{
    --bg:#f0f2f5;--panel:#ffffff;--card:#ffffff;--text:#111b21;
    --sub:#667781;--accent:#25d366;--border:#e9edef;
  }
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial}
.app{max-width:900px;margin:auto;min-height:100vh;display:flex;flex-direction:column}
.topbar{background:var(--panel);padding:14px 16px;font-size:18px;font-weight:600;border-bottom:1px solid var(--border)}
.content{padding:12px;flex:1}
.card{background:var(--card);border-radius:12px;padding:14px;margin-bottom:12px}
h2{font-size:14px;color:var(--sub);margin:0 0 8px;text-transform:uppercase}
.row{display:grid;grid-template-columns:2fr 2fr 1fr;gap:16px;margin-bottom:14px}
.grid{display:grid;grid-template-columns:2fr 2fr 1fr;gap:16px;margin-bottom:14px}
input{width:100%;padding:12px;font-size:16px;border-radius:8px;border:1px solid var(--border);background:transparent;color:var(--text)}
label{font-size:12px;color:var(--sub);cursor:pointer}
.chips{display:flex;gap:18px;flex-wrap:wrap}
.chip{padding:8px 14px;border-radius:16px;border:1px solid var(--border);font-size:14px}
input:checked + .chip{background:var(--accent);color:#fff;border-color:var(--accent)}
input[type=checkbox],input[type=radio]{display:none}
.footer{position:sticky;bottom:0;background:var(--panel);padding:12px;border-top:1px solid var(--border)}
button{width:100%;padding:8px;font-size:16px;font-weight:600;border:none;border-radius:8px;background:var(--accent);color:#fff}
.bubble{background:var(--card);border-radius:14px;padding:12px;margin-bottom:8px}
.value{color:var(--accent);font-weight:600}
.hidden{display:none}
</style>
</head>
<body>
<div class="app">
  <div class="topbar">Pavimentação</div>
  <div class="content">

    <div class="card">
      <h2>Método de cálculo</h2>
      <div class="chips">
        <label><input type="radio" name="metodo" value="total" checked onchange="toggleMetodo()"><span class="chip">Pista inteira</span></label>
        <label><input type="radio" name="metodo" value="faixas" onchange="toggleMetodo()"><span class="chip">Bordo / pista</span></label>
      </div>
    </div>

    <div id="modo_total" class="card">
      <h2>Pista inteira</h2>
      <div class="grid">
        <div><label>Estaca inicial</label><input id="pi_ini"></div>
        <div><label>Estaca final</label><input id="pi_fim"></div>
        <div><label>Largura CBUQ (m)</label><input id="pi_larg"></div>
      </div>
      <label for="usarBanco">
        <input type="checkbox" id="usarBanco" checked>
        <span class="chip">Usar larguras do projeto</span>
      </label>
    </div>

    <div id="modo_faixas" class="card hidden">
      <h2>Bordo / pista – CBUQ</h2>
      <div class="row">
        <div><label>Bordo Esq – Est. Inicial</label><input id="be_ini"></div>
        <div><label>Bordo Esq – Est. Final</label><input id="be_fim"></div>
        <div><label>Largura (m)</label><input id="be_l"></div>
      </div>
      <div class="row">
        <div><label>Pista Esq – Est. Inicial</label><input id="pe_ini"></div>
        <div><label>Pista Esq – Est. Final</label><input id="pe_fim"></div>
        <div><label>Largura (m)</label><input id="pe_l"></div>
      </div>
      <div class="row">
        <div><label>Pista Dir – Est. Inicial</label><input id="pd_ini"></div>
        <div><label>Pista Dir – Est. Final</label><input id="pd_fim"></div>
        <div><label>Largura (m)</label><input id="pd_l"></div>
      </div>
      <div class="row">
        <div><label>Bordo Dir – Est. Inicial</label><input id="bd_ini"></div>
        <div><label>Bordo Dir – Est. Final</label><input id="bd_fim"></div>
        <div><label>Largura (m)</label><input id="bd_l"></div>
      </div>
    </div>

    <div class="card">
      <h2>Materiais</h2>
      <div class="chips">
        <label><input type="checkbox" id="cbuq" checked><span class="chip">CBUQ</span></label>
        <label><input type="checkbox" id="bref"><span class="chip">Bica Reforço</span></label>
        <label><input type="checkbox" id="bsub"><span class="chip">Bica Sub-base</span></label>
        <label><input type="checkbox" id="bgs"><span class="chip">BGS</span></label>
      </div>
    </div>

    <div class="card">
      <h2>Resultado</h2>
      <div id="resultado"></div>
    </div>
  </div>

  <div class="footer">
    <button onclick="calcular()">Calcular</button>
  </div>
</div>

<script>
function fmtBR(valor, casas = 2){
  return Number(valor).toLocaleString('pt-BR', {
    minimumFractionDigits: casas,
    maximumFractionDigits: casas
  });
}

const materiais={
  CBUQ:{esp:0.05,dens:2.53,preco:263.04,delta:0},
  BREF:{esp:0.30,dens:2.4,preco:180.59,delta:1.92},
  BSUB:{esp:0.20,dens:2.4,preco:180.59,delta:1.12},
  BGS:{esp:0.15,dens:2.4,preco:241.97,delta:0.52}
};
const lig={CAP:0.048,RR:0.0007,EAI:0.0012};
const ligPreco={CAP:5547.75,RR:4476.94,EAI:5716.46};

let bancoLarguras=[];
fetch('./larguras.json').then(r=>r.json()).then(d=>bancoLarguras=d);

function toggleMetodo(){
  const metodo=document.querySelector('input[name="metodo"]:checked').value;
  modo_total.classList.toggle('hidden',metodo!=='total');
  modo_faixas.classList.toggle('hidden',metodo!=='faixas');
}

function estacaM(v){
  if(!v) return NaN;
  v=v.replace(',','.');
  if(!v.includes('+')) return Number(v)*20;
  const [e,f]=v.split('+');
  return Number(e)*20+Number(f);
}

function calcFaixa(ei,ef,l){
  const c=estacaM(ef)-estacaM(ei);
  const largura=Number(l.replace(',','.'));
  if(!c||!largura||c<=0) return null;
  return {c,largura};
}

function faixasPorBanco(ei,ef){
  const ini=estacaM(ei);
  const fim=estacaM(ef);
  let faixas=[];
  bancoLarguras.forEach(s=>{
    const si=estacaM(s.ini);
    const sf=estacaM(s.fim);
    const a=Math.max(ini,si);
    const b=Math.min(fim,sf);
    if(b>a){
      faixas.push({
        nome:'Pista inteira',
        c:b-a,
        largura:s.bordo_esq+s.pista_esq+s.pista_dir+s.bordo_dir
      });
    }
  });
  return faixas;
}

function calcular(){
  let faixas=[];
  const metodo=document.querySelector('input[name="metodo"]:checked').value;

  if(metodo==='total'){
    if(usarBanco.checked){
      if(!bancoLarguras.length){
        resultado.innerHTML='<div class="bubble">Banco de larguras não carregado</div>';
        return;
      }
      faixas=faixasPorBanco(pi_ini.value,pi_fim.value);
      if(!faixas.length){
        resultado.innerHTML='<div class="bubble">Trecho fora do banco de larguras</div>';
        return;
      }
    } else {
      const c=estacaM(pi_fim.value)-estacaM(pi_ini.value);
      const l=Number(pi_larg.value.replace(',','.'));
      if(!c||!l||c<=0){
        resultado.innerHTML='<div class="bubble">Dados inválidos</div>';
        return;
      }
      faixas.push({nome:'Pista inteira',c,largura:l});
    }
  } else {
    const f=[
      ['Bordo Esq',be_ini,be_fim,be_l],
      ['Pista Esq',pe_ini,pe_fim,pe_l],
      ['Pista Dir',pd_ini,pd_fim,pd_l],
      ['Bordo Dir',bd_ini,bd_fim,bd_l]
    ];
    f.forEach(x=>{
      const r=calcFaixa(x[1].value,x[2].value,x[3].value);
      if(r) faixas.push({nome:x[0],...r});
    });
    if(!faixas.length){
      resultado.innerHTML='<div class="bubble">Dados inválidos</div>';
      return;
    }
  }

  let html='';

  if(cbuq.checked){
    let area=0;
    faixas.forEach(f=>area+=f.c*f.largura);
    const vol=area*materiais.CBUQ.esp;
    const ton=vol*materiais.CBUQ.dens;
    const Valor=ton*materiais.CBUQ.preco;

    const cap_t=ton*lig.CAP;
    const rr_v=area*lig.RR;
    const eai_v=area*lig.EAI;

    const ValorLig=cap_t*ligPreco.CAP + rr_v*ligPreco.RR + eai_v*ligPreco.EAI;

    html+=`<div class="bubble">CBUQ: <span class="value">${fmtBR(ton)} t</span></div>`;
    html+=`<div class="bubble">Custo CBUQ: <span class="value">R$ ${fmtBR(custo)}</span></div>`;
    html+=`<div class="bubble">CAP: ${fmtBR(cap_t)} t</div>`;
    html+=`<div class="bubble">RR-1C: ${fmtBR(rr_v,3)} t</div>`;
    html+=`<div class="bubble">EAI: ${fmtBR(eai_v,3)} t</div>`;
    html+=`<div class="bubble">Custo ligantes: <span class="value">R$ ${fmtBR(custoLig)}</span></div>`;
  }

  [['bref','BREF','Bica Reforço'],['bsub','BSUB','Bica Sub-base'],['bgs','BGS','BGS']].forEach(g=>{
    if(!document.getElementById(g[0]).checked) return;
    const cfg=materiais[g[1]];
    let area=0;
    faixas.forEach(f=>area+=f.c*(f.largura+cfg.delta));
    const vol=area*cfg.esp;
    const ton=vol*cfg.dens;
    const Valor=vol*cfg.preco;

    html+=`<div class="bubble">${g[2]}: ${fmtBR(vol)} m³</div>`;
    html+=`<div class="bubble">${g[2]}: ${fmtBR(ton)} t</div>`;
    html+=`<div class="bubble">Custo ${g[2]}: <span class="value">R$ ${fmtBR(custo)}</span></div>`;
  });

  resultado.innerHTML=html;
}
</script>
</body>
</html>
